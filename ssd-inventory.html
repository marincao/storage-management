<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Â∫ìÂ≠òÁÆ°ÁêÜÁ≥ªÁªü ¬∑ SSD Inventory</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0f14;--surface:#13161e;--surface2:#1a1e28;--border:#252a38;--border2:#2e3547;
    --accent:#00d4aa;--accent2:#0099ff;--accent3:#ff6b35;
    --text:#e2e8f0;--text2:#8b96b0;--text3:#4a5568;
    --green:#22c55e;--red:#ef4444;
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'IBM Plex Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,212,170,0.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,212,170,0.03) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0}
  .wrapper{position:relative;z-index:1}

  /* CONFIG */
  .config-screen{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center}
  .config-screen.hidden{display:none}
  .config-box{background:var(--surface);border:1px solid var(--border2);border-radius:10px;padding:40px;width:560px;max-width:95vw}
  .config-logo-mark{width:48px;height:48px;background:var(--accent);clip-path:polygon(20% 0%,80% 0%,100% 50%,80% 100%,20% 100%,0% 50%);margin:0 auto 12px}
  .config-title{font-family:'IBM Plex Mono',monospace;font-size:16px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:var(--accent);text-align:center}
  .config-sub{font-size:12px;color:var(--text2);text-align:center;margin-top:6px;line-height:1.6}
  .config-steps{margin-top:24px;display:flex;flex-direction:column;gap:14px}
  .config-step{display:flex;gap:12px;align-items:flex-start}
  .step-num{width:22px;height:22px;min-width:22px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:600;color:var(--bg);margin-top:2px}
  .step-text{font-size:12px;color:var(--text2);line-height:1.6}
  .step-text a{color:var(--accent2);text-decoration:none}
  .step-text b{color:var(--text)}
  .step-text code{background:var(--surface2);padding:2px 6px;border-radius:3px;font-family:'IBM Plex Mono',monospace;font-size:11px;color:var(--accent)}
  .sql-box{margin-top:20px;background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:14px;position:relative}
  .sql-label{font-family:'IBM Plex Mono',monospace;font-size:9px;color:var(--text3);letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
  #copy-sql-btn{position:absolute;top:12px;right:12px;background:var(--border2);border:none;color:var(--text2);font-family:'IBM Plex Mono',monospace;font-size:9px;padding:4px 10px;border-radius:3px;cursor:pointer;letter-spacing:1px;text-transform:uppercase}
  .sql-pre{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text2);white-space:pre-wrap;line-height:1.6;overflow:auto;max-height:150px}
  .config-inputs{display:flex;flex-direction:column;gap:12px;margin-top:24px}
  .config-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);margin-bottom:4px;display:block}
  .config-input{width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border2);color:var(--text);font-family:'IBM Plex Mono',monospace;font-size:12px;border-radius:4px;outline:none;transition:border .2s}
  .config-input:focus{border-color:var(--accent)}
  .config-input::placeholder{color:var(--text3)}
  #connect-btn{width:100%;margin-top:8px;padding:12px;background:var(--accent);border:none;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--bg);cursor:pointer;transition:all .2s}
  #connect-btn:hover{background:#00f0c0;box-shadow:0 0 20px rgba(0,212,170,0.4)}
  #connect-btn:disabled{opacity:0.5;cursor:not-allowed}
  .config-err{font-size:11px;color:var(--red);text-align:center;font-family:'IBM Plex Mono',monospace;margin-top:10px;display:none}

  /* HEADER */
  header{display:flex;align-items:center;justify-content:space-between;padding:18px 32px;border-bottom:1px solid var(--border);background:rgba(13,15,20,0.9);backdrop-filter:blur(12px);position:sticky;top:0;z-index:100}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-mark{width:36px;height:36px;background:var(--accent);clip-path:polygon(20% 0%,80% 0%,100% 50%,80% 100%,20% 100%,0% 50%);display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-size:11px;font-weight:600;color:var(--bg);animation:pulse 3s ease-in-out infinite}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,212,170,0.4)}50%{box-shadow:0 0 0 8px rgba(0,212,170,0)}}
  .logo-text{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;letter-spacing:2px;text-transform:uppercase}
  .logo-sub{font-size:10px;color:var(--text2);letter-spacing:3px;font-weight:300}
  .header-right{display:flex;align-items:center;gap:16px}
  .live-badge{display:inline-flex;align-items:center;gap:6px;font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--accent);letter-spacing:1px;text-transform:uppercase}
  .live-dot{width:6px;height:6px;background:var(--accent);border-radius:50%;animation:blink 1.5s ease-in-out infinite}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  #disconnect-btn{font-family:'IBM Plex Mono',monospace;font-size:10px;color:var(--text3);background:none;border:1px solid var(--border);border-radius:3px;padding:4px 8px;cursor:pointer;transition:all .2s}
  #disconnect-btn:hover{border-color:var(--red);color:var(--red)}

  /* TABS */
  .tabs{display:flex;border-bottom:1px solid var(--border);padding:0 32px;background:var(--surface)}
  .tab{padding:14px 24px;font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all .2s}
  .tab:hover{color:var(--text)}
  .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
  .tab.sales-tab.active{color:var(--accent3);border-bottom-color:var(--accent3)}

  /* STATS */
  .stats-bar{display:flex;gap:1px;background:var(--border);border-bottom:1px solid var(--border);padding:0 32px}
  .stat-card{flex:1;padding:16px 20px;background:var(--surface);display:flex;flex-direction:column;gap:4px;transition:background .2s}
  .stat-card:hover{background:var(--surface2)}
  .stat-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text3)}
  .stat-value{font-family:'IBM Plex Mono',monospace;font-size:22px;font-weight:600;color:var(--accent)}
  .stat-value.blue{color:var(--accent2)}.stat-value.orange{color:var(--accent3)}.stat-value.green{color:var(--green)}.stat-value.red{color:var(--red)}

  /* TOOLBAR */
  .toolbar{display:flex;align-items:center;gap:12px;padding:16px 32px;border-bottom:1px solid var(--border);flex-wrap:wrap}
  .date-display{font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--text2);padding:8px 16px;border:1px solid var(--border2);border-radius:4px;background:var(--surface);margin-right:auto}
  input,select,textarea{background:var(--surface);border:1px solid var(--border2);color:var(--text);font-family:'IBM Plex Sans JP',sans-serif;font-size:13px;border-radius:4px;outline:none;transition:border .2s,box-shadow .2s}
  input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(0,212,170,0.1)}
  .search-box{padding:8px 14px;width:220px}
  .filter-select{padding:8px 14px;cursor:pointer}
  select option{background:var(--surface)}
  .btn{padding:8px 20px;border:none;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:12px;font-weight:500;letter-spacing:1px;cursor:pointer;transition:all .2s;text-transform:uppercase}
  .btn-primary{background:var(--accent);color:var(--bg)}
  .btn-primary:hover{background:#00f0c0;box-shadow:0 0 20px rgba(0,212,170,0.4);transform:translateY(-1px)}
  .btn-secondary{background:transparent;color:var(--text2);border:1px solid var(--border2)}
  .btn-secondary:hover{border-color:var(--accent2);color:var(--accent2)}
  .btn-sales{background:var(--accent3);color:#fff}
  .btn-sales:hover{background:#ff8c5a;box-shadow:0 0 20px rgba(255,107,53,0.4);transform:translateY(-1px)}
  .action-btn{border:none;border-radius:3px;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;letter-spacing:1px;cursor:pointer;transition:all .2s;text-transform:uppercase;padding:5px 10px}
  .btn-sel{background:rgba(255,107,53,0.1);color:var(--accent3);border:1px solid rgba(255,107,53,0.3)}
  .btn-sel:hover{background:rgba(255,107,53,0.2);border-color:var(--accent3)}
  .btn-edit{background:rgba(0,153,255,0.1);color:var(--accent2);border:1px solid rgba(0,153,255,0.3)}
  .btn-edit:hover{background:rgba(0,153,255,0.2);border-color:var(--accent2)}
  .btn-del{background:rgba(239,68,68,0.08);color:var(--red);border:1px solid rgba(239,68,68,0.2)}
  .btn-del:hover{background:rgba(239,68,68,0.15);border-color:var(--red)}

  /* TABLE */
  .table-container{padding:0 32px 32px;overflow-x:auto}
  .table-title{font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--text2);padding:20px 0 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .table-title::before{content:'';display:inline-block;width:3px;height:14px;background:var(--accent);border-radius:2px}
  .table-title.sales-title::before{background:var(--accent3)}
  table{width:100%;border-collapse:collapse;font-size:12px;min-width:1100px}
  thead tr{background:var(--surface);border-bottom:2px solid var(--accent)}
  thead tr.sales-head{border-bottom-color:var(--accent3)}
  th{padding:10px 14px;text-align:left;font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);white-space:nowrap;user-select:none}
  th.sortable{cursor:pointer}th.sortable:hover{color:var(--accent)}
  tbody tr{border-bottom:1px solid var(--border);transition:background .15s}
  tbody tr:hover{background:rgba(0,212,170,0.03)}
  td{padding:11px 14px;color:var(--text);white-space:nowrap}
  td.mono{font-family:'IBM Plex Mono',monospace;font-size:11px}
  .tag{display:inline-flex;align-items:center;padding:3px 8px;border-radius:3px;font-family:'IBM Plex Mono',monospace;font-size:10px;font-weight:500;letter-spacing:1px}
  .tag-green{background:rgba(34,197,94,0.1);color:var(--green);border:1px solid rgba(34,197,94,0.2)}
  .tag-blue{background:rgba(0,153,255,0.1);color:var(--accent2);border:1px solid rgba(0,153,255,0.2)}
  .tag-orange{background:rgba(255,107,53,0.1);color:var(--accent3);border:1px solid rgba(255,107,53,0.2)}
  .tag-gray{background:rgba(139,150,176,0.1);color:var(--text2);border:1px solid rgba(139,150,176,0.2)}
  .tag-red{background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.2)}
  tfoot tr{background:var(--surface);border-top:2px solid var(--border2)}
  tfoot td{font-family:'IBM Plex Mono',monospace;font-weight:600;color:var(--accent);padding:12px 14px}
  .sort-ind{margin-left:4px;color:var(--accent)}
  .profit-pos{color:var(--green);font-family:'IBM Plex Mono',monospace;font-weight:600}
  .profit-neg{color:var(--red);font-family:'IBM Plex Mono',monospace;font-weight:600}
  .loading-msg td{text-align:center;color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:11px;letter-spacing:2px;padding:40px}

  /* EMPTY */
  .empty-state{text-align:center;padding:60px 20px;color:var(--text3);font-family:'IBM Plex Mono',monospace;font-size:12px;letter-spacing:2px;display:none}
  .empty-icon{font-size:40px;margin-bottom:16px;opacity:.3}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);z-index:200;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
  .modal-overlay.open{opacity:1;pointer-events:all}
  .modal{background:var(--surface);border:1px solid var(--border2);border-radius:8px;width:660px;max-width:95vw;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:transform .2s;box-shadow:0 24px 80px rgba(0,0,0,0.6)}
  .modal-overlay.open .modal{transform:translateY(0)}
  .modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .modal-title{font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:var(--accent)}
  .modal-title.orange{color:var(--accent3)}
  .modal-close{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;padding:4px 8px;transition:color .2s}
  .modal-close:hover{color:var(--text)}
  .modal-body{padding:24px}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .form-group{display:flex;flex-direction:column;gap:6px}
  .form-group.full{grid-column:1/-1}
  .form-label{font-family:'IBM Plex Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--text2)}
  .form-input{padding:10px 12px;width:100%}
  .modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px}
  .inv-info-box{background:var(--surface2);border:1px solid var(--border2);border-radius:6px;padding:14px;margin-bottom:20px;font-size:12px;color:var(--text2);font-family:'IBM Plex Mono',monospace;line-height:1.8}

  .page{display:none}.page.active{display:block}

  .notif{position:fixed;bottom:32px;right:32px;padding:14px 20px;background:var(--surface);border:1px solid var(--accent);border-radius:6px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:var(--accent);z-index:500;transform:translateY(100px);opacity:0;transition:all .3s;box-shadow:0 8px 32px rgba(0,212,170,0.2)}
  .notif.show{transform:translateY(0);opacity:1}

  ::-webkit-scrollbar{width:6px;height:6px}
  ::-webkit-scrollbar-track{background:var(--bg)}
  ::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
</style>
</head>
<body>
<div class="wrapper">

<!-- CONFIG SCREEN -->
<div class="config-screen" id="config-screen">
  <div class="config-box">
    <div style="text-align:center;margin-bottom:28px">
      <div class="config-logo-mark"></div>
      <div class="config-title">SSD Â∫ìÂ≠òÁÆ°ÁêÜÁ≥ªÁªü</div>
      <div class="config-sub">Enter your Supabase credentials to connect.<br>All users share the same live database.</div>
    </div>
    <div class="config-steps">
      <div class="config-step"><div class="step-num">1</div><div class="step-text">Go to <a href="https://supabase.com" target="_blank">supabase.com</a> ‚Üí open your project ‚Üí <b>SQL Editor</b> ‚Üí run the SQL below (only needed once).</div></div>
      <div class="config-step"><div class="step-num">2</div><div class="step-text">Go to <b>Project Settings ‚Üí API</b>. Copy your <code>Project URL</code> and <code>anon public key</code>.</div></div>
      <div class="config-step"><div class="step-num">3</div><div class="step-text">Paste them below and click Connect. Credentials are saved in your browser ‚Äî you only do this once per device.</div></div>
    </div>
    <div class="sql-box">
      <div class="sql-label">One-time setup SQL</div>
      <button id="copy-sql-btn">COPY</button>
      <pre class="sql-pre" id="setup-sql">CREATE TABLE IF NOT EXISTS inventory (
  id BIGSERIAL PRIMARY KEY,
  entry_date TEXT, spec TEXT, part_number TEXT,
  quantity INTEGER, unit_price NUMERIC,
  linda_payment NUMERIC, avg_cost NUMERIC,
  total_quantity INTEGER, min_package TEXT,
  cargo_owner TEXT, status TEXT DEFAULT 'ÂæÖÂîÆ',
  warehouse_status TEXT, notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS sales (
  id BIGSERIAL PRIMARY KEY,
  sale_date TEXT NOT NULL, spec TEXT, part_number TEXT,
  quantity INTEGER, sale_price NUMERIC, sale_total NUMERIC,
  cost_price NUMERIC, profit NUMERIC,
  buyer TEXT, notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
ALTER TABLE inventory ENABLE ROW LEVEL SECURITY;
ALTER TABLE sales ENABLE ROW LEVEL SECURITY;
CREATE POLICY "public_inv" ON inventory FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "public_sales" ON sales FOR ALL USING (true) WITH CHECK (true);</pre>
    </div>
    <div class="config-inputs">
      <div>
        <label class="config-label">Supabase Project URL</label>
        <input class="config-input" id="cfg-url" type="text" placeholder="https://xxxxxxxxxxxx.supabase.co">
      </div>
      <div>
        <label class="config-label">Supabase Anon Public Key</label>
        <input class="config-input" id="cfg-key" type="password" placeholder="eyJhbGci...">
      </div>
    </div>
    <div class="config-err" id="cfg-err"></div>
    <button id="connect-btn">CONNECT DATABASE ‚Üí</button>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-mark">SSD</div>
    <div><div class="logo-text">Â∫ìÂ≠òÁÆ°ÁêÜÁ≥ªÁªü</div><div class="logo-sub">SSD Inventory Management</div></div>
  </div>
  <div class="header-right">
    <div class="live-badge"><div class="live-dot"></div>SUPABASE ¬∑ LIVE</div>
    <button id="disconnect-btn">DISCONNECT</button>
  </div>
</header>

<!-- TABS -->
<div class="tabs">
  <div class="tab active" data-tab="inventory">üì¶ Â∫ìÂ≠ò Inventory</div>
  <div class="tab sales-tab" data-tab="sales">üí∞ ÈîÄÂîÆ Sales & Profit</div>
</div>

<!-- INVENTORY PAGE -->
<div class="page active" id="page-inventory">
  <div class="stats-bar">
    <div class="stat-card"><div class="stat-label">Total Entries</div><div class="stat-value" id="stat-entries">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Total Quantity</div><div class="stat-value blue" id="stat-qty">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">LINDA‰ªòÊ¨æÊÄªÈ¢ù</div><div class="stat-value orange" id="stat-total">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">SKU Types</div><div class="stat-value green" id="stat-skus">‚Äî</div></div>
  </div>
  <div class="toolbar">
    <div class="date-display" id="inv-date"></div>
    <input class="search-box" type="text" id="inv-search" placeholder="ÊêúÁ¥¢ ÊñôÂè∑ / ËßÑÊ†º / Ë¥ß‰∏ª...">
    <select class="filter-select" id="inv-filter-spec"><option value="">All ËßÑÊ†º</option></select>
    <select class="filter-select" id="inv-filter-status"><option value="">All Ë¥ßÂÜµ</option></select>
    <button class="btn btn-secondary" id="inv-export-btn">EXPORT CSV</button>
    <button class="btn btn-primary" id="inv-add-btn">+ ADD ENTRY</button>
  </div>
  <div class="table-container">
    <div class="table-title">Inventory Records</div>
    <table>
      <thead><tr id="inv-thead">
        <th class="sortable" data-col="entry_date">ÂÖ•Â∫ìÊó•Êúü<span class="sort-ind" id="is-entry_date"></span></th>
        <th class="sortable" data-col="spec">ËßÑÊ†º<span class="sort-ind" id="is-spec"></span></th>
        <th class="sortable" data-col="part_number">ÊñôÂè∑<span class="sort-ind" id="is-part_number"></span></th>
        <th class="sortable" data-col="quantity">Êï∞Èáè<span class="sort-ind" id="is-quantity"></span></th>
        <th class="sortable" data-col="unit_price">Âçï‰ª∑<span class="sort-ind" id="is-unit_price"></span></th>
        <th class="sortable" data-col="linda_payment">LINDA‰ªòÊ¨æÈáëÈ¢ù<span class="sort-ind" id="is-linda_payment"></span></th>
        <th class="sortable" data-col="avg_cost">Âπ≥ÂùáÊàêÊú¨<span class="sort-ind" id="is-avg_cost"></span></th>
        <th class="sortable" data-col="total_quantity">ÊÄªÊï∞Èáè<span class="sort-ind" id="is-total_quantity"></span></th>
        <th>ÊúÄÂ∞èÂåÖË£Ö/ÁÆ±</th>
        <th class="sortable" data-col="cargo_owner">Ë¥ß‰∏ª<span class="sort-ind" id="is-cargo_owner"></span></th>
        <th class="sortable" data-col="status">Ë¥ßÂÜµ<span class="sort-ind" id="is-status"></span></th>
        <th>ÂÖ•‰ªìÊÉÖÂÜµ</th><th>Â§áÊ≥®</th>
        <th style="text-align:center">Êìç‰Ωú</th>
      </tr></thead>
      <tbody id="inv-tbody"><tr class="loading-msg"><td colspan="14">CONNECTING...</td></tr></tbody>
      <tfoot><tr><td colspan="3">TOTAL</td><td id="inv-foot-qty" class="mono">‚Äî</td><td></td><td id="inv-foot-linda" class="mono">‚Äî</td><td colspan="8"></td></tr></tfoot>
    </table>
    <div class="empty-state" id="inv-empty"><div class="empty-icon">üì¶</div>NO RECORDS FOUND</div>
  </div>
</div>

<!-- SALES PAGE -->
<div class="page" id="page-sales">
  <div class="stats-bar">
    <div class="stat-card"><div class="stat-label">Total Transactions</div><div class="stat-value" id="ss-count">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Units Sold</div><div class="stat-value blue" id="ss-units">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Total Revenue</div><div class="stat-value orange" id="ss-revenue">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Total Profit</div><div class="stat-value green" id="ss-profit">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Profit Margin</div><div class="stat-value" id="ss-margin">‚Äî</div></div>
  </div>
  <div class="toolbar">
    <div class="date-display" id="sales-date"></div>
    <input class="search-box" type="text" id="sales-search" placeholder="ÊêúÁ¥¢ ÊñôÂè∑ / ËßÑÊ†º / ‰π∞ÂÆ∂...">
    <select class="filter-select" id="sales-filter-spec"><option value="">All ËßÑÊ†º</option></select>
    <button class="btn btn-secondary" id="sales-export-btn">EXPORT CSV</button>
    <button class="btn btn-sales" id="sales-add-btn">+ RECORD SALE</button>
  </div>
  <div class="table-container">
    <div class="table-title sales-title">Sales Records</div>
    <table>
      <thead><tr class="sales-head" id="sales-thead">
        <th class="sortable" data-col="sale_date">ÈîÄÂîÆÊó•Êúü<span class="sort-ind" id="ss-sale_date"></span></th>
        <th class="sortable" data-col="spec">ËßÑÊ†º<span class="sort-ind" id="ss-spec"></span></th>
        <th class="sortable" data-col="part_number">ÊñôÂè∑<span class="sort-ind" id="ss-part_number"></span></th>
        <th class="sortable" data-col="quantity">Êï∞Èáè<span class="sort-ind" id="ss-quantity"></span></th>
        <th class="sortable" data-col="sale_price">ÈîÄÂîÆÂçï‰ª∑<span class="sort-ind" id="ss-sale_price"></span></th>
        <th class="sortable" data-col="sale_total">ÈîÄÂîÆÊÄªÈ¢ù<span class="sort-ind" id="ss-sale_total"></span></th>
        <th class="sortable" data-col="cost_price">ÊàêÊú¨Âçï‰ª∑<span class="sort-ind" id="ss-cost_price"></span></th>
        <th class="sortable" data-col="profit">Âà©Ê∂¶<span class="sort-ind" id="ss-profit-col"></span></th>
        <th>Âà©Ê∂¶Áéá</th>
        <th class="sortable" data-col="buyer">‰π∞ÂÆ∂<span class="sort-ind" id="ss-buyer"></span></th>
        <th>Â§áÊ≥®</th><th style="text-align:center">Êìç‰Ωú</th>
      </tr></thead>
      <tbody id="sales-tbody"><tr class="loading-msg"><td colspan="12">CONNECTING...</td></tr></tbody>
      <tfoot><tr>
        <td colspan="3">TOTAL</td>
        <td id="sales-foot-qty" class="mono">‚Äî</td><td></td>
        <td id="sales-foot-rev" class="mono">‚Äî</td><td></td>
        <td id="sales-foot-profit" class="mono">‚Äî</td>
        <td id="sales-foot-margin" class="mono">‚Äî</td>
        <td colspan="3"></td>
      </tr></tfoot>
    </table>
    <div class="empty-state" id="sales-empty"><div class="empty-icon">üí∞</div>NO SALES RECORDED YET</div>
  </div>
</div>

<!-- INV MODAL -->
<div class="modal-overlay" id="inv-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="inv-modal-title">ADD NEW ENTRY</div><button class="modal-close" id="inv-modal-close">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">ÂÖ•Â∫ìÊó•Êúü *</label><input class="form-input" type="date" id="fi-entry_date"></div>
        <div class="form-group"><label class="form-label">ËßÑÊ†º *</label><input class="form-input" type="text" id="fi-spec" placeholder="e.g. EMMC 8G"></div>
        <div class="form-group"><label class="form-label">ÊñôÂè∑ *</label><input class="form-input" type="text" id="fi-part_number" placeholder="e.g. KLM8G1GETF-B041006"></div>
        <div class="form-group"><label class="form-label">Êï∞Èáè *</label><input class="form-input" type="number" id="fi-quantity" placeholder="0"></div>
        <div class="form-group"><label class="form-label">Âçï‰ª∑</label><input class="form-input" type="number" step="0.01" id="fi-unit_price" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">LINDA‰ªòÊ¨æÈáëÈ¢ù</label><input class="form-input" type="number" step="0.01" id="fi-linda_payment" placeholder="0.00"></div>

        <div class="form-group"><label class="form-label">ÊúÄÂ∞èÂåÖË£Ö/ÁÆ±</label><input class="form-input" type="text" id="fi-min_package" placeholder="1120/4480/ÁÆ±"></div>
        <div class="form-group"><label class="form-label">Ë¥ß‰∏ª</label><input class="form-input" type="text" id="fi-cargo_owner" placeholder="e.g. LINDA"></div>
        <div class="form-group"><label class="form-label">Ë¥ßÂÜµ</label>
          <select class="form-input" id="fi-status"><option value="ÂæÖÂîÆ">ÂæÖÂîÆ</option><option value="Â∑≤ÂîÆ">Â∑≤ÂîÆ</option><option value="È¢ÑÂîÆ">È¢ÑÂîÆ</option><option value="Áº∫Ë¥ß">Áº∫Ë¥ß</option></select>
        </div>
        <div class="form-group"><label class="form-label">ÂÖ•‰ªìÊÉÖÂÜµ</label><input class="form-input" type="text" id="fi-warehouse_status" placeholder="e.g. ‰ø°Êù∞"></div>
        <div class="form-group full"><label class="form-label">Â§áÊ≥®</label><textarea class="form-input" id="fi-notes" rows="2" placeholder="Â§áÊ≥®‰ø°ÊÅØ..."></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="inv-modal-cancel">CANCEL</button>
      <button class="btn btn-primary" id="inv-modal-save">SAVE ENTRY</button>
    </div>
  </div>
</div>

<!-- SEL MODAL -->
<div class="modal-overlay" id="sell-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title orange">RECORD SALE</div><button class="modal-close" id="sell-modal-close">‚úï</button></div>
    <div class="modal-body">
      <div class="inv-info-box" id="sell-info"></div>
      <div class="form-grid">
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÊó•Êúü *</label><input class="form-input" type="date" id="fs-sale_date"></div>
        <div class="form-group"><label class="form-label">Êï∞Èáè *</label><input class="form-input" type="number" id="fs-quantity" placeholder="0"></div>
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÂçï‰ª∑ *</label><input class="form-input" type="number" step="0.01" id="fs-sale_price" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">ÊàêÊú¨Âçï‰ª∑</label><input class="form-input" type="number" step="0.01" id="fs-cost_price" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÊÄªÈ¢ù (auto)</label><input class="form-input" type="number" id="fs-sale_total" readonly style="color:var(--accent3)"></div>
        <div class="form-group"><label class="form-label">Âà©Ê∂¶ (auto)</label><input class="form-input" type="number" id="fs-profit" readonly style="color:var(--green)"></div>
        <div class="form-group"><label class="form-label">‰π∞ÂÆ∂</label><input class="form-input" type="text" id="fs-buyer" placeholder="‰π∞ÂÆ∂ÂêçÁß∞"></div>
        <div class="form-group full"><label class="form-label">Â§áÊ≥®</label><textarea class="form-input" id="fs-notes" rows="2" placeholder="Â§áÊ≥®..."></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="sell-modal-cancel">CANCEL</button>
      <button class="btn btn-sales" id="sell-modal-save">CONFIRM SALE</button>
    </div>
  </div>
</div>

<!-- SALE MODAL -->
<div class="modal-overlay" id="sale-modal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title orange" id="sale-modal-title">RECORD SALE</div><button class="modal-close" id="sale-modal-close">‚úï</button></div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÊó•Êúü *</label><input class="form-input" type="date" id="fsa-sale_date"></div>
        <div class="form-group"><label class="form-label">ËßÑÊ†º</label><input class="form-input" type="text" id="fsa-spec" placeholder="e.g. EMMC 8G"></div>
        <div class="form-group"><label class="form-label">ÊñôÂè∑</label><input class="form-input" type="text" id="fsa-part_number" placeholder="e.g. KLM8G..."></div>
        <div class="form-group"><label class="form-label">Êï∞Èáè *</label><input class="form-input" type="number" id="fsa-quantity" placeholder="0"></div>
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÂçï‰ª∑ *</label><input class="form-input" type="number" step="0.01" id="fsa-sale_price" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">ÊàêÊú¨Âçï‰ª∑</label><input class="form-input" type="number" step="0.01" id="fsa-cost_price" placeholder="0.00"></div>
        <div class="form-group"><label class="form-label">ÈîÄÂîÆÊÄªÈ¢ù (auto)</label><input class="form-input" type="number" id="fsa-sale_total" readonly style="color:var(--accent3)"></div>
        <div class="form-group"><label class="form-label">Âà©Ê∂¶ (auto)</label><input class="form-input" type="number" id="fsa-profit" readonly style="color:var(--green)"></div>
        <div class="form-group"><label class="form-label">‰π∞ÂÆ∂</label><input class="form-input" type="text" id="fsa-buyer" placeholder="‰π∞ÂÆ∂ÂêçÁß∞"></div>
        <div class="form-group full"><label class="form-label">Â§áÊ≥®</label><textarea class="form-input" id="fsa-notes" rows="2" placeholder="Â§áÊ≥®..."></textarea></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="sale-modal-cancel">CANCEL</button>
      <button class="btn btn-sales" id="sale-modal-save">SAVE SALE</button>
    </div>
  </div>
</div>

<div class="notif" id="notif"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE REST API ‚Äî plain fetch(), no SDK needed
//  Supabase exposes a PostgREST endpoint at:
//  {PROJECT_URL}/rest/v1/{table}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let API_URL = '';
let API_KEY = '';

function sbHeaders(extra) {
  return {
    'apikey': API_KEY,
    'Authorization': 'Bearer ' + API_KEY,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation',
    ...extra
  };
}

async function sbSelect(table) {
  const res = await fetch(`${API_URL}/rest/v1/${table}?select=*&order=created_at.asc`, { headers: sbHeaders() });
  if (!res.ok) throw new Error((await res.json()).message || res.statusText);
  return res.json();
}

async function sbInsert(table, row) {
  const res = await fetch(`${API_URL}/rest/v1/${table}`, {
    method: 'POST',
    headers: sbHeaders(),
    body: JSON.stringify(row)
  });
  if (!res.ok) throw new Error((await res.json()).message || res.statusText);
  return res.json();
}

async function sbUpdate(table, id, row) {
  const res = await fetch(`${API_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'PATCH',
    headers: sbHeaders(),
    body: JSON.stringify(row)
  });
  if (!res.ok) throw new Error((await res.json()).message || res.statusText);
  return res.json();
}

async function sbDelete(table, id) {
  const res = await fetch(`${API_URL}/rest/v1/${table}?id=eq.${id}`, {
    method: 'DELETE',
    headers: sbHeaders()
  });
  if (!res.ok) throw new Error((await res.json()).message || res.statusText);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let invData = [], salesData = [];
let invEditId = null, saleEditId = null, sellInvRow = null;
let invSortCol = 'entry_date', invSortAsc = false;
let salesSortCol = 'sale_date', salesSortAsc = false;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
const today = () => new Date().toISOString().split('T')[0];
const fmt = n => n != null ? Number(n).toLocaleString('zh-CN') : '';
const fmtM = n => n != null ? Number(n).toLocaleString('zh-CN', {minimumFractionDigits:2}) : '';
const statusTag = s => {
  const m = {'ÂæÖÂîÆ':'tag-green','Â∑≤ÂîÆ':'tag-gray','È¢ÑÂîÆ':'tag-orange','Áº∫Ë¥ß':'tag-red'};
  return `<span class="tag ${m[s]||'tag-gray'}">${s||''}</span>`;
};
function showNotif(msg, err=false) {
  const el = $('notif');
  el.textContent = msg;
  el.style.borderColor = err ? 'var(--red)' : 'var(--accent)';
  el.style.color = err ? 'var(--red)' : 'var(--accent)';
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2800);
}
function openModal(id) { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

// ‚îÄ‚îÄ DATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('inv-date').textContent = new Date().toLocaleDateString('zh-CN',{month:'long',day:'numeric'}) + 'Â∫ìÂ≠òË°®';
$('sales-date').textContent = new Date().toLocaleDateString('zh-CN',{year:'numeric',month:'long'}) + 'ÈîÄÂîÆËÆ∞ÂΩï';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONNECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const saved = JSON.parse(localStorage.getItem('ssd_cfg') || 'null');
if (saved) {
  API_URL = saved.url.replace(/\/$/, '');
  API_KEY = saved.key;
  sbSelect('inventory').then(() => showApp()).catch(() => {
    API_URL = ''; API_KEY = '';
    localStorage.removeItem('ssd_cfg');
  });
}

$('copy-sql-btn').addEventListener('click', () => {
  navigator.clipboard.writeText($('setup-sql').textContent);
  $('copy-sql-btn').textContent = 'COPIED!';
  setTimeout(() => $('copy-sql-btn').textContent = 'COPY', 2000);
});

$('connect-btn').addEventListener('click', async () => {
  const url = $('cfg-url').value.trim().replace(/\/$/, '');
  const key = $('cfg-key').value.trim();
  const errEl = $('cfg-err');
  errEl.style.display = 'none';
  if (!url || !key) { errEl.textContent = 'Both fields are required.'; errEl.style.display = 'block'; return; }
  $('connect-btn').disabled = true;
  $('connect-btn').textContent = 'CONNECTING...';
  try {
    API_URL = url; API_KEY = key;
    await sbSelect('inventory'); // test connection
    localStorage.setItem('ssd_cfg', JSON.stringify({url, key}));
    showApp();
  } catch(e) {
    API_URL = ''; API_KEY = '';
    errEl.textContent = 'Connection failed: ' + e.message;
    errEl.style.display = 'block';
    $('connect-btn').disabled = false;
    $('connect-btn').textContent = 'CONNECT DATABASE ‚Üí';
  }
});

$('disconnect-btn').addEventListener('click', () => {
  if (!confirm('Disconnect from database?')) return;
  localStorage.removeItem('ssd_cfg');
  location.reload();
});

function showApp() {
  $('config-screen').classList.add('hidden');
  loadInventory();
  loadSales();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    $('page-' + tab.dataset.tab).classList.add('active');
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVENTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadInventory() {
  try {
    invData = await sbSelect('inventory');
    renderInventory(); refreshInvFilters(); updateInvStats();
  } catch(e) { showNotif('Load error: ' + e.message, true); }
}

function calcGroupStats(rows) {
  const groups = {};
  rows.forEach(r => {
    const key = r.spec || '';
    if (!groups[key]) groups[key] = { totalQty: 0, totalCost: 0 };
    const qty = r.quantity || 0;
    const cost = parseFloat(r.unit_price) || 0;
    groups[key].totalQty += qty;
    groups[key].totalCost += qty * cost;
  });
  Object.keys(groups).forEach(k => {
    const g = groups[k];
    g.avgCost = g.totalQty > 0 ? g.totalCost / g.totalQty : 0;
  });
  return groups;
}

function renderInventory() {
  const search = $('inv-search').value.toLowerCase();
  const specF = $('inv-filter-spec').value;
  const statusF = $('inv-filter-status').value;
  let rows = invData.filter(r =>
    (!specF || r.spec === specF) && (!statusF || r.status === statusF) &&
    (!search || ['spec','part_number','cargo_owner','notes'].some(f => (r[f]||'').toLowerCase().includes(search)))
  );
  // Sort: primary by spec so groups stay together, secondary by user col
  rows.sort((a,b) => {
    if ((a.spec||'') < (b.spec||'')) return -1;
    if ((a.spec||'') > (b.spec||'')) return 1;
    let av = a[invSortCol]??'', bv = b[invSortCol]??'';
    return invSortAsc ? (av>bv?1:-1) : (av<bv?1:-1);
  });
  $('inv-empty').style.display = rows.length ? 'none' : 'block';

  // Compute per-spec totals from ALL invData (not just filtered) so stats are always accurate
  const groups = calcGroupStats(invData);

  let html = '';
  let i = 0;
  while (i < rows.length) {
    const spec = rows[i].spec || '';
    let j = i;
    while (j < rows.length && (rows[j].spec||'') === spec) j++;
    const groupSize = j - i;
    const grp = groups[spec] || { avgCost: 0, totalQty: 0 };
    for (let k = i; k < j; k++) {
      const r = rows[k];
      const isFirst = (k === i);
      html += `<tr>
        <td class="mono">${r.entry_date||''}</td>
        <td>${r.spec||''}</td>
        <td class="mono" style="font-size:10px">${r.part_number||''}</td>
        <td class="mono">${fmt(r.quantity)}</td>
        <td class="mono">${r.unit_price!=null?(+r.unit_price).toFixed(2):''}</td>
        <td class="mono">${r.linda_payment!=null?fmtM(r.linda_payment):''}</td>
        ${isFirst
          ? `<td class="mono" rowspan="${groupSize}" style="background:rgba(0,212,170,0.06);border-left:2px solid var(--accent);vertical-align:middle;text-align:center;font-weight:600;color:var(--accent)">${grp.avgCost.toFixed(2)}</td>
             <td class="mono" rowspan="${groupSize}" style="background:rgba(0,153,255,0.06);border-left:2px solid var(--accent2);vertical-align:middle;text-align:center;font-weight:600;color:var(--accent2)">${fmt(grp.totalQty)}</td>`
          : ''}
        <td class="mono" style="font-size:10px">${r.min_package||''}</td>
        <td>${r.cargo_owner?`<span class="tag tag-blue">${r.cargo_owner}</span>`:''}</td>
        <td>${statusTag(r.status)}</td>
        <td>${r.warehouse_status||''}</td>
        <td style="max-width:130px;white-space:normal;font-size:11px;color:var(--text2)">${r.notes||''}</td>
        <td style="text-align:center;display:flex;gap:4px;justify-content:center;padding:8px 14px">
          <button class="action-btn btn-sel" data-action="sel" data-id="${r.id}">SEL</button>
          <button class="action-btn btn-edit" data-action="inv-edit" data-id="${r.id}">EDIT</button>
          <button class="action-btn btn-del" data-action="inv-del" data-id="${r.id}">DEL</button>
        </td>
      </tr>`;
    }
    i = j;
  }
  $('inv-tbody').innerHTML = html;
  $('inv-foot-qty').textContent = fmt(rows.reduce((s,r)=>s+(r.quantity||0),0));
  $('inv-foot-linda').textContent = fmtM(rows.reduce((s,r)=>s+(+r.linda_payment||0),0));
  document.querySelectorAll('[id^="is-"]').forEach(el => el.textContent='');
  const si = $('is-'+invSortCol); if(si) si.textContent = invSortAsc?' ‚ñ≤':' ‚ñº';
}

function updateInvStats() {
  $('stat-entries').textContent = invData.length;
  $('stat-qty').textContent = fmt(invData.reduce((s,r)=>s+(r.quantity||0),0));
  $('stat-total').textContent = '¬•'+fmtM(invData.reduce((s,r)=>s+(+r.linda_payment||0),0));
  $('stat-skus').textContent = new Set(invData.map(r=>r.part_number)).size;
}

function refreshInvFilters() {
  const specSel = $('inv-filter-spec'), cur = specSel.value;
  specSel.innerHTML = '<option value="">All ËßÑÊ†º</option>' +
    [...new Set(invData.map(r=>r.spec).filter(Boolean))].sort().map(s=>`<option value="${s}"${s===cur?' selected':''}>${s}</option>`).join('');
  const stSel = $('inv-filter-status'), curS = stSel.value;
  stSel.innerHTML = '<option value="">All Ë¥ßÂÜµ</option>' +
    [...new Set(invData.map(r=>r.status).filter(Boolean))].sort().map(s=>`<option value="${s}"${s===curS?' selected':''}>${s}</option>`).join('');
}

$('inv-thead').addEventListener('click', e => {
  const th = e.target.closest('th.sortable'); if(!th) return;
  invSortCol===th.dataset.col ? invSortAsc=!invSortAsc : (invSortCol=th.dataset.col, invSortAsc=true);
  renderInventory();
});
$('inv-search').addEventListener('input', renderInventory);
$('inv-filter-spec').addEventListener('change', renderInventory);
$('inv-filter-status').addEventListener('change', renderInventory);

$('inv-tbody').addEventListener('click', async e => {
  const btn = e.target.closest('[data-action]'); if(!btn) return;
  const id = +btn.dataset.id, action = btn.dataset.action;
  if (action==='sel') openSellModal(id);
  if (action==='inv-edit') openInvModal(id);
  if (action==='inv-del') {
    if (!confirm('Delete this entry?')) return;
    try { await sbDelete('inventory', id); showNotif('Deleted'); await loadInventory(); }
    catch(e) { showNotif('Error: '+e.message, true); }
  }
});

$('inv-export-btn').addEventListener('click', () => exportCSV(invData, 'inventory'));

// ‚îÄ‚îÄ INV MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('inv-add-btn').addEventListener('click', () => openInvModal(null));
['inv-modal-close','inv-modal-cancel'].forEach(id => $(id).addEventListener('click', () => closeModal('inv-modal')));
$('inv-modal').addEventListener('click', e => { if(e.target===$('inv-modal')) closeModal('inv-modal'); });

function openInvModal(id) {
  invEditId = id;
  $('inv-modal-title').textContent = id ? 'EDIT ENTRY' : 'ADD NEW ENTRY';
  const fields = ['entry_date','spec','part_number','quantity','unit_price','linda_payment','min_package','cargo_owner','status','warehouse_status','notes'];
  if (id) {
    const r = invData.find(x=>x.id===id);
    fields.forEach(f => { const el=$('fi-'+f); if(el) el.value=r[f]??''; });
  } else {
    fields.forEach(f => { const el=$('fi-'+f); if(el) el.value=''; });
    $('fi-entry_date').value=today(); $('fi-status').value='ÂæÖÂîÆ';
    $('fi-cargo_owner').value='LINDA'; $('fi-min_package').value='1120/4480/ÁÆ±';
  }
  openModal('inv-modal');
}

$('inv-modal-save').addEventListener('click', async () => {
  const g = f => $('fi-'+f).value.trim();
  if (!g('entry_date')||!g('spec')||!g('part_number')) { showNotif('Fill required fields (*)', true); return; }
  const payload = {
    entry_date:g('entry_date'), spec:g('spec'), part_number:g('part_number'),
    quantity:parseInt(g('quantity'))||0, unit_price:parseFloat(g('unit_price'))||null,
    linda_payment:parseFloat(g('linda_payment'))||null, min_package:g('min_package')||null,
    cargo_owner:g('cargo_owner')||null, status:g('status')||'ÂæÖÂîÆ',
    warehouse_status:g('warehouse_status')||null, notes:g('notes')||null,
  };
  try {
    invEditId ? await sbUpdate('inventory', invEditId, payload) : await sbInsert('inventory', payload);
    showNotif(invEditId ? 'Entry updated ‚úì' : 'Entry added ‚úì');
    closeModal('inv-modal'); await loadInventory();
  } catch(e) { showNotif('Error: '+e.message, true); }
});

// ‚îÄ‚îÄ SEL MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
['sell-modal-close','sell-modal-cancel'].forEach(id => $(id).addEventListener('click', () => closeModal('sell-modal')));
$('sell-modal').addEventListener('click', e => { if(e.target===$('sell-modal')) closeModal('sell-modal'); });

function openSellModal(invId) {
  sellInvRow = invData.find(r=>r.id===invId); if(!sellInvRow) return;
  // calculate group avg_cost from all rows of same spec
  const grpRows = invData.filter(r => r.spec === sellInvRow.spec);
  const grpQty = grpRows.reduce((s,r)=>s+(r.quantity||0),0);
  const grpCost = grpRows.reduce((s,r)=>s+((r.quantity||0)*(parseFloat(r.unit_price)||0)),0);
  const grpAvgCost = grpQty > 0 ? grpCost / grpQty : 0;
  const grpTotalQty = grpQty;
  $('sell-info').innerHTML =
    `ËßÑÊ†º: <b style="color:var(--text)">${sellInvRow.spec||''}</b> &nbsp;|&nbsp; ÊñôÂè∑: <b style="color:var(--text)">${sellInvRow.part_number||''}</b><br>` +
    `ÊÄªÊï∞Èáè: <b style="color:var(--accent)">${fmt(grpTotalQty)}</b> &nbsp;|&nbsp; Âπ≥ÂùáÊàêÊú¨: <b style="color:var(--accent3)">${grpAvgCost.toFixed(2)}</b>`;
  ['sale_date','quantity','sale_price','sale_total','profit','buyer','notes'].forEach(f=>{const el=$('fs-'+f);if(el)el.value='';});
  $('fs-sale_date').value=today(); $('fs-cost_price').value=grpAvgCost.toFixed(2);
  openModal('sell-modal');
}

function calcSell() {
  const qty=parseFloat($('fs-quantity').value)||0, sp=parseFloat($('fs-sale_price').value)||0, cp=parseFloat($('fs-cost_price').value)||0;
  $('fs-sale_total').value=qty&&sp?(qty*sp).toFixed(2):'';
  $('fs-profit').value=qty&&sp?(qty*(sp-cp)).toFixed(2):'';
}
['fs-quantity','fs-sale_price','fs-cost_price'].forEach(id=>$(id).addEventListener('input',calcSell));

$('sell-modal-save').addEventListener('click', async () => {
  const g=f=>$('fs-'+f).value.trim();
  const qty=parseInt(g('quantity'))||0, sp=parseFloat(g('sale_price'));
  if (!g('sale_date')||!qty||!sp){showNotif('Fill required fields',true);return;}
  const cp=parseFloat(g('cost_price'))||null;
  try {
    await sbInsert('sales',{sale_date:g('sale_date'),quantity:qty,sale_price:sp,sale_total:qty*sp,cost_price:cp,profit:cp!=null?qty*(sp-cp):null,spec:sellInvRow.spec,part_number:sellInvRow.part_number,buyer:g('buyer')||null,notes:g('notes')||null});
    showNotif('Sale recorded ‚úì');
    closeModal('sell-modal');
    await loadSales();
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab')[1].classList.add('active');
    document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
    $('page-sales').classList.add('active');
  } catch(e){showNotif('Error: '+e.message,true);}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSales() {
  try {
    salesData = await sbSelect('sales');
    renderSales(); refreshSalesFilters(); updateSalesStats();
  } catch(e) { showNotif('Load error: '+e.message, true); }
}

function renderSales() {
  const search=$('sales-search').value.toLowerCase(), specF=$('sales-filter-spec').value;
  let rows=salesData.filter(r=>(!specF||r.spec===specF)&&(!search||['spec','part_number','buyer','notes'].some(f=>(r[f]||'').toLowerCase().includes(search))));
  rows.sort((a,b)=>{let av=a[salesSortCol]??'',bv=b[salesSortCol]??'';return salesSortAsc?(av>bv?1:-1):(av<bv?1:-1);});
  $('sales-empty').style.display=rows.length?'none':'block';
  $('sales-tbody').innerHTML=rows.map(r=>{
    const margin=r.sale_total&&r.profit!=null?(+r.profit/+r.sale_total*100).toFixed(1)+'%':'‚Äî';
    const pc=+r.profit>=0?'profit-pos':'profit-neg';
    return `<tr>
      <td class="mono">${r.sale_date||''}</td><td>${r.spec||''}</td>
      <td class="mono" style="font-size:10px">${r.part_number||''}</td>
      <td class="mono">${fmt(r.quantity)}</td>
      <td class="mono">${r.sale_price!=null?(+r.sale_price).toFixed(2):''}</td>
      <td class="mono" style="color:var(--accent3)">${r.sale_total!=null?fmtM(r.sale_total):''}</td>
      <td class="mono">${r.cost_price!=null?(+r.cost_price).toFixed(2):''}</td>
      <td class="${pc}">${r.profit!=null?fmtM(r.profit):'‚Äî'}</td>
      <td class="mono" style="color:var(--text2)">${margin}</td>
      <td>${r.buyer?`<span class="tag tag-blue">${r.buyer}</span>`:''}</td>
      <td style="max-width:130px;white-space:normal;font-size:11px;color:var(--text2)">${r.notes||''}</td>
      <td style="text-align:center;display:flex;gap:4px;justify-content:center;padding:8px 14px">
        <button class="action-btn btn-edit" data-action="sale-edit" data-id="${r.id}">EDIT</button>
        <button class="action-btn btn-del" data-action="sale-del" data-id="${r.id}">DEL</button>
      </td></tr>`;
  }).join('');
  const totRev=rows.reduce((s,r)=>s+(+r.sale_total||0),0), totP=rows.reduce((s,r)=>s+(+r.profit||0),0);
  $('sales-foot-qty').textContent=fmt(rows.reduce((s,r)=>s+(r.quantity||0),0));
  $('sales-foot-rev').textContent=fmtM(totRev);
  const fp=$('sales-foot-profit'); fp.textContent=fmtM(totP); fp.style.color=totP>=0?'var(--green)':'var(--red)';
  $('sales-foot-margin').textContent=totRev?(totP/totRev*100).toFixed(1)+'%':'‚Äî';
  document.querySelectorAll('[id^="ss-"]').forEach(el=>{if(el.classList.contains('sort-ind'))el.textContent='';});
  const si=$('ss-'+salesSortCol); if(si) si.textContent=salesSortAsc?' ‚ñ≤':' ‚ñº';
}

function updateSalesStats() {
  const rev=salesData.reduce((s,r)=>s+(+r.sale_total||0),0), prof=salesData.reduce((s,r)=>s+(+r.profit||0),0);
  $('ss-count').textContent=salesData.length;
  $('ss-units').textContent=fmt(salesData.reduce((s,r)=>s+(r.quantity||0),0));
  $('ss-revenue').textContent='¬•'+fmtM(rev);
  const pe=$('ss-profit'); pe.textContent='¬•'+fmtM(prof); pe.className='stat-value '+(prof>=0?'green':'red');
  $('ss-margin').textContent=rev?(prof/rev*100).toFixed(1)+'%':'‚Äî';
}

function refreshSalesFilters() {
  const sel=$('sales-filter-spec'), cur=sel.value;
  sel.innerHTML='<option value="">All ËßÑÊ†º</option>'+[...new Set(salesData.map(r=>r.spec).filter(Boolean))].sort().map(s=>`<option value="${s}"${s===cur?' selected':''}>${s}</option>`).join('');
}

$('sales-thead').addEventListener('click',e=>{
  const th=e.target.closest('th.sortable');if(!th)return;
  salesSortCol===th.dataset.col?salesSortAsc=!salesSortAsc:(salesSortCol=th.dataset.col,salesSortAsc=true);
  renderSales();
});
$('sales-search').addEventListener('input',renderSales);
$('sales-filter-spec').addEventListener('change',renderSales);

$('sales-tbody').addEventListener('click',async e=>{
  const btn=e.target.closest('[data-action]');if(!btn)return;
  const id=+btn.dataset.id,action=btn.dataset.action;
  if(action==='sale-edit')openSaleModal(id);
  if(action==='sale-del'){
    if(!confirm('Delete this sale?'))return;
    try{await sbDelete('sales',id);showNotif('Deleted');await loadSales();}
    catch(e){showNotif('Error: '+e.message,true);}
  }
});

$('sales-export-btn').addEventListener('click',()=>exportCSV(salesData,'sales'));

// ‚îÄ‚îÄ SALE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('sales-add-btn').addEventListener('click',()=>openSaleModal(null));
['sale-modal-close','sale-modal-cancel'].forEach(id=>$(id).addEventListener('click',()=>closeModal('sale-modal')));
$('sale-modal').addEventListener('click',e=>{if(e.target===$('sale-modal'))closeModal('sale-modal');});

function openSaleModal(id) {
  saleEditId=id;
  $('sale-modal-title').textContent=id?'EDIT SALE':'RECORD SALE';
  const fields=['sale_date','spec','part_number','quantity','sale_price','cost_price','sale_total','profit','buyer','notes'];
  if(id){const r=salesData.find(x=>x.id===id);fields.forEach(f=>{const el=$('fsa-'+f);if(el)el.value=r[f]??'';});}
  else{fields.forEach(f=>{const el=$('fsa-'+f);if(el)el.value='';});$('fsa-sale_date').value=today();}
  openModal('sale-modal');
}

function calcSale(){
  const qty=parseFloat($('fsa-quantity').value)||0,sp=parseFloat($('fsa-sale_price').value)||0,cp=parseFloat($('fsa-cost_price').value)||0;
  $('fsa-sale_total').value=qty&&sp?(qty*sp).toFixed(2):'';
  $('fsa-profit').value=qty&&sp?(qty*(sp-cp)).toFixed(2):'';
}
['fsa-quantity','fsa-sale_price','fsa-cost_price'].forEach(id=>$(id).addEventListener('input',calcSale));

$('sale-modal-save').addEventListener('click',async()=>{
  const g=f=>$('fsa-'+f).value.trim();
  const qty=parseInt(g('quantity'))||0,sp=parseFloat(g('sale_price'));
  if(!g('sale_date')||!qty||!sp){showNotif('Fill required fields',true);return;}
  const cp=parseFloat(g('cost_price'))||null;
  const payload={sale_date:g('sale_date'),quantity:qty,sale_price:sp,sale_total:qty*sp,cost_price:cp,profit:cp!=null?qty*(sp-cp):null,spec:g('spec')||null,part_number:g('part_number')||null,buyer:g('buyer')||null,notes:g('notes')||null};
  try{
    saleEditId?await sbUpdate('sales',saleEditId,payload):await sbInsert('sales',payload);
    showNotif(saleEditId?'Sale updated ‚úì':'Sale recorded ‚úì');
    closeModal('sale-modal');await loadSales();
  }catch(e){showNotif('Error: '+e.message,true);}
});

// ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV(data,name){
  if(!data.length){showNotif('No data to export');return;}
  const keys=Object.keys(data[0]);
  const csv=[keys.join(','),...data.map(r=>keys.map(k=>JSON.stringify(r[k]??'')).join(','))].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob(['\ufeff'+csv],{type:'text/csv;charset=utf-8'}));
  a.download=`ssd_${name}_${today()}.csv`;a.click();
  showNotif('CSV exported');
}
</script>
</body>
</html>
